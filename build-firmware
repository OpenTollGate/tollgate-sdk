#!/bin/bash
set -e

SCRIPT_DIR="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Install dependencies
# ./install-deps.sh
# Add this function to check feeds status
check_feeds() {
    local sdk_path=$1
    
    # Check if feeds directory exists and has content
    if [ -d "${sdk_path}/feeds" ] && [ "$(ls -A ${sdk_path}/feeds)" ]; then
        # Check if package index exists and is recent (less than 1 day old)
        if [ -f "${sdk_path}/feeds/packages.index" ]; then
            local file_age=$(( $(date +%s) - $(stat -c %Y "${sdk_path}/feeds/packages.index") ))
            local day_seconds=86400
            
            if [ ${file_age} -lt ${day_seconds} ]; then
                echo "Feeds are up to date, skipping update..."
                return 0
            fi
        fi
    fi
    return 1
}

# Check if the required argument is provided
if [ $# -ne 1 ]; then
    echo "Usage: $0 <model>"
    exit 1
fi

MODEL=$1
VERSION=23.05.3
SDKDIR=/tmp/openwrt-sdk

# Set platform variables based on model
case $MODEL in
    "gl-mt300n-v2")
        PLATFORM="ramips"
        SUBTARGET="mt76x8"
        ;;
    "gl-ar300m")
        PLATFORM="ath79"
        SUBTARGET="generic"
        ;;
    "gl-mt3000"|"gl-mt6000")
        PLATFORM="mediatek"
        SUBTARGET="filogic"
        ;;
    "gl-e750")
        VERSION="snapshot"
        PLATFORM="ath79"
        SUBTARGET="nand"
        ;;
    "archer_mr200")
        PLATFORM="ramips"
        SUBTARGET="mt7620"
        ;;
    *)
        echo "Unsupported model. Supported models: gl-mt300n-v2, gl-ar300m, gl-mt3000, gl-mt6000, gl-e750, archer_mr200"
        exit 1
        ;;
esac

SDK_ARCHIVE="openwrt-sdk-${VERSION}-${PLATFORM}-${SUBTARGET}_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
DOWNLOAD_URL="https://downloads.openwrt.org/releases/${VERSION}/targets/${PLATFORM}/${SUBTARGET}/${SDK_ARCHIVE}"
SDK_PATH="${SDKDIR}/openwrt-sdk-${VERSION}-${PLATFORM}-${SUBTARGET}_gcc-12.3.0_musl.Linux-x86_64"

# Prepare SDK directory
if [ ! -d "${SDKDIR}" ] ; then
    mkdir -p "${SDKDIR}"
fi

# Download and extract SDK
if [ ! -f "${SDKDIR}/${SDK_ARCHIVE}" ]; then
    echo "Downloading SDK..."
    (cd "${SDKDIR}" && curl -O "${DOWNLOAD_URL}")
fi

echo "Extracting SDK..."
tar -I "xz -T0" -xf "${SDKDIR}/${SDK_ARCHIVE}" -C "${SDKDIR}"

# Change to SDK directory
cd "${SDK_PATH}"

echo "Script dir: $SCRIPT_DIR"
cp "${SCRIPT_DIR}"/feeds.conf "${SDK_PATH}"/feeds.conf

# Update feeds
echo "Updating feeds..."
"${SDK_PATH}"/./scripts/feeds update -a
"${SDK_PATH}"/./scripts/feeds install -a

# Configure and build
echo "Configuring SDK..."
make defconfig

echo "Building golang first..."
make package/feeds/custom/golang/compile V=sc

echo "Building all TollGate modules..."
MODULES=(
    "merchant"
    "valve"
    "whoami"
    "crowsnest"
    "tollgate-module-relay-go"
)

echo "Building all TollGate modules..."
for module in "${MODULES[@]}"; do
    echo "Building ${module}..."
    make package/feeds/custom/${module}/compile V=sc
done

# Find all built packages and print their paths
BUILT_PACKAGES_DIR=$(find "${SDK_PATH}/bin/packages" -name "tollgate-module-*.ipk" -exec dirname {} \; | head -n 1)

echo -e "\nUploading packages to blossom and creating nostr event..."
# Run the aggregate info script for all packages
python3 "${SCRIPT_DIR}/aggregate_info.py" "${BUILT_PACKAGES_DIR}" "${SCRIPT_DIR}/feeds.conf" "${SDK_PATH}" > /tmp/aggregate_output.txt
noscl publish "$(cat note.md)"

# List all built packages
echo "Built packages:"
find "${BUILT_PACKAGES_DIR}" -name "tollgate-module-*.ipk" -exec ls -l {} \;
